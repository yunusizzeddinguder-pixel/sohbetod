<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sohbetod Pro | Bildirimli</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #6366f1; --success: #10b981; --danger: #ef4444; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Outfit', sans-serif; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #6366f1; }
        
        /* Lobi Tasarƒ±mƒ± */
        #lobby-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; padding: 20px; color: white; text-align: center; }
        .lobby-card { background: white; color: #333; padding: 30px; border-radius: 30px; width: 100%; max-width: 380px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
        .room-btn { width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 15px; background: var(--primary); color: white; font-weight: 600; cursor: pointer; }

        /* Ana Uygulama */
        #app-container { display: none; width: 100%; height: 100%; background: white; position: relative; }
        .chat-app { width: 100%; height: 100%; display: flex; flex-direction: column; }
        header { padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; background: white; }
        
        #messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; background: #f8fafc; }

        /* Mesaj Balonlarƒ± */
        .msg-wrapper { display: flex; flex-direction: column; max-width: 85%; }
        .sent-wrapper { align-self: flex-end; }
        .received-wrapper { align-self: flex-start; }
        .msg-box { padding: 10px 14px; border-radius: 18px; font-size: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .sent { background: var(--primary); color: white; border-bottom-right-radius: 4px; }
        .received { background: white; color: #333; border: 1px solid #ddd; border-bottom-left-radius: 4px; }
        
        /* Alt Panel */
        .input-area { padding: 10px; border-top: 1px solid #eee; background: white; padding-bottom: env(safe-area-inset-bottom); }
        .input-row { display: flex; gap: 8px; align-items: center; }
        #msg-input { flex: 1; padding: 12px; border-radius: 20px; border: 1px solid #ddd; font-size: 16px; outline: none; }
        .btn-icon { width: 44px; height: 44px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; background: #f1f5f9; font-size: 20px; }
        .recording { background: var(--danger) !important; color: white !important; animation: pulse 1s infinite; }
        
        /* Grup Bilgi Paneli */
        #group-info-panel { position: absolute; top: 0; right: -100%; width: 100%; height: 100%; background: white; z-index: 1000; padding: 25px; transition: 0.3s; display: flex; flex-direction: column; }
        #group-info-panel.active { right: 0; }
        
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <audio id="notif-sound" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3" preload="auto"></audio>

    <div id="lobby-screen">
        <h1 style="font-size: 2.5rem; margin-bottom: 20px;">Sohbetod</h1>
        <div class="lobby-card" id="auth-section">
            <button class="room-btn" id="google-login-btn">Google ile Giri≈ü Yap</button>
        </div>
        <div class="lobby-card" id="room-section" style="display:none;">
            <h3>Merhaba, <span id="user-display-name">...</span></h3>
            <button class="room-btn" onclick="enterRoom(prompt('Oda Adƒ±:'))">Oda Olu≈ütur / Katƒ±l</button>
        </div>
    </div>

    <div id="app-container">
        <div id="group-info-panel">
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h2 style="margin:0">Grup Bilgileri</h2>
                <button onclick="toggleInfo()" style="background:none; border:none; font-size:24px;">‚úï</button>
            </div>
            <div id="user-list"></div>
            <button onclick="location.reload()" style="margin-top:auto; padding:15px; border:none; background:#fee2e2; color:red; border-radius:15px; font-weight:bold;">√áIKI≈û YAP</button>
        </div>

        <div class="chat-app">
            <header>
                <div onclick="toggleInfo()" style="cursor:pointer">
                    <span style="font-size:10px; color:var(--primary); font-weight:bold;">‚ÑπÔ∏è GRUP Bƒ∞LGƒ∞Sƒ∞</span><br>
                    <b id="active-room-name">#oda</b>
                </div>
                <button class="btn-icon" onclick="shareRoom()" style="background:none;">üîó</button>
            </header>

            <div id="messages"></div>

            <div class="input-area">
                <div class="input-row">
                    <button id="voice-msg-btn" class="btn-icon" onclick="toggleVoiceMessage()">üé§</button>
                    <input type="file" id="img-input" accept="image/*" style="display:none" onchange="sendImage(this)">
                    <button class="btn-icon" onclick="document.getElementById('img-input').click()">üñºÔ∏è</button>
                    <input type="text" id="msg-input" placeholder="Mesaj yaz..." autocomplete="off">
                    <button onclick="send()" class="btn-icon" style="background:var(--primary); color:white;">‚û§</button>
                </div>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, onValue, set, get, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyCqhaA5yE-V_88mNovVQHOC9k90hsrUYVM",
        authDomain: "sohbet-1e450.firebaseapp.com",
        databaseURL: "https://sohbet-1e450-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "sohbet-1e450",
        storageBucket: "sohbet-1e450.firebasestorage.app",
        appId: "1:339709433578:web:847062b4f5f7e07633e993"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    let myName, myRoom, currentPath;
    let mediaRecorder, audioChunks = [];
    let isTabActive = true;

    // Sekme odaƒüƒ±nƒ± takip et
    window.onfocus = () => isTabActive = true;
    window.onblur = () => isTabActive = false;

    // Bildirim ƒ∞zni ƒ∞ste
    async function requestNotifPermission() {
        if (Notification.permission !== 'granted') {
            await Notification.requestPermission();
        }
    }

    document.getElementById("google-login-btn").onclick = () => {
        requestNotifPermission();
        signInWithPopup(auth, provider);
    };

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            myName = user.displayName;
            document.getElementById("auth-section").style.display = "none";
            document.getElementById("room-section").style.display = "block";
            document.getElementById("user-display-name").innerText = myName;
            const urlParams = new URLSearchParams(window.location.search);
            if(urlParams.get('room')) enterRoom(urlParams.get('room'));
        }
    });

    window.enterRoom = async (name) => {
        if(!name) return;
        name = name.toLowerCase().replace(/\s+/g, '-');
        const roomRef = ref(db, `room_configs/${name}`);
        const snap = await get(roomRef);
        let pass = snap.exists() ? prompt("Oda ≈ûifresi:") : prompt("Yeni ≈ûifre:");
        
        if (snap.exists() && pass !== snap.val().pass) return alert("Hatalƒ±!");
        if (!snap.exists()) await set(roomRef, { pass: pass || "123" });

        myRoom = name;
        currentPath = `rooms/${myRoom}/msgs`;
        document.getElementById("lobby-screen").style.display = "none";
        document.getElementById("app-container").style.display = "block";
        document.getElementById("active-room-name").innerText = "#" + myRoom;
        
        const presenceRef = ref(db, `rooms/${myRoom}/users/${myName}`);
        set(presenceRef, true);
        onDisconnect(presenceRef).remove();
        loadChat();
    };

    function loadChat() {
        let firstLoad = true;
        onChildAdded(ref(db, currentPath), (s) => {
            const data = s.val();
            renderMsg(s.key, data);
            
            // Yeni mesaj bildirimi (Sadece mesaj bizden deƒüilse ve sayfa y√ºklendikten sonra)
            if (!firstLoad && data.u !== myName) {
                document.getElementById("notif-sound").play();
                if (!isTabActive && Notification.permission === 'granted') {
                    new Notification("Sohbetod", { body: `${data.u}: ${data.m || "Bir medya g√∂nderdi"}`, icon: "https://cdn-icons-png.flaticon.com/512/5962/5962461.png" });
                }
            }
        });
        // ƒ∞lk y√ºkleme bittiƒüinde i≈üaretle
        setTimeout(() => { firstLoad = false; }, 2000);

        onValue(ref(db, `rooms/${myRoom}/users`), (s) => {
            const users = s.val() || {};
            document.getElementById("user-list").innerHTML = Object.keys(users).map(u => `<div style="padding:10px; background:#f1f5f9; margin-bottom:5px; border-radius:10px;">üë§ ${u}</div>`).join('');
        });
    }

    function renderMsg(id, data) {
        const isMe = data.u === myName;
        const html = `
            <div class="msg-wrapper ${isMe ? 'sent-wrapper' : 'received-wrapper'}">
                <div class="msg-box ${isMe ? 'sent' : 'received'}">
                    <small style="font-size:10px; opacity:0.7; display:block;">${data.u}</small>
                    ${data.img ? `<img src="${data.img}" class="msg-img">` : ''}
                    ${data.v ? `<audio src="${data.v}" controls></audio>` : ''}
                    ${data.m ? `<span>${data.m}</span>` : ''}
                </div>
            </div>`;
        document.getElementById("messages").insertAdjacentHTML('beforeend', html);
        document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
    }

    window.send = (img = null, voice = null) => {
        const inp = document.getElementById("msg-input");
        if (inp.value || img || voice) {
            push(ref(db, currentPath), { u: myName, m: inp.value || null, img: img || null, v: voice || null, t: Date.now() });
            inp.value = "";
        }
    };

    window.sendImage = (i) => {
        const file = i.files[0];
        const reader = new FileReader();
        reader.onload = (e) => send(e.target.result);
        reader.readAsDataURL(file);
    };

    window.toggleVoiceMessage = async () => {
        const btn = document.getElementById("voice-msg-btn");
        if (!mediaRecorder || mediaRecorder.state === "inactive") {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = () => {
                const blob = new Blob(audioChunks, { type: 'audio/webm' });
                const reader = new FileReader();
                reader.readAsDataURL(blob);
                reader.onloadend = () => send(null, reader.result);
            };
            mediaRecorder.start();
            btn.classList.add("recording");
        } else {
            mediaRecorder.stop();
            btn.classList.remove("recording");
        }
    };

    window.toggleInfo = () => document.getElementById("group-info-panel").classList.toggle("active");
    window.shareRoom = () => {
        const url = window.location.origin + window.location.pathname + "?room=" + myRoom;
        navigator.clipboard.writeText(url);
        alert("Link kopyalandƒ±!");
    };
</script>
</body>
</html>
