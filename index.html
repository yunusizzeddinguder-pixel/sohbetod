<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sohbetod Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #6366f1; --glass: rgba(255, 255, 255, 0.95); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Outfit', sans-serif; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #f1f5f9; display: flex; justify-content: center; }
        
        #app-container { display: none; width: 100%; height: 100%; max-width: 500px; position: relative; background: white; }
        .chat-app { width: 100%; height: 100%; display: flex; flex-direction: column; }

        /* Header & Info */
        header { padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
        #group-info-panel { position: absolute; top: 0; right: -100%; width: 100%; height: 100%; background: white; z-index: 1000; padding: 25px; transition: 0.3s; display: flex; flex-direction: column; }
        #group-info-panel.active { right: 0; }

        /* Messages */
        #messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; background: #f8fafc; }
        .msg-wrapper { display: flex; flex-direction: column; max-width: 85%; position: relative; }
        .sent-wrapper { align-self: flex-end; }
        .received-wrapper { align-self: flex-start; }
        
        .msg-box { padding: 10px 14px; border-radius: 18px; font-size: 15px; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .sent { background: var(--primary); color: white; border-bottom-right-radius: 4px; }
        .received { background: white; color: #333; border: 1px solid #e2e8f0; border-bottom-left-radius: 4px; }
        .msg-img { max-width: 100%; border-radius: 12px; margin-top: 5px; }

        /* Reactions & Menus */
        .reactions-row { display: flex; gap: 4px; margin-top: -8px; padding: 0 8px; z-index: 5; }
        .react-badge { background: white; border: 1px solid #eee; border-radius: 10px; padding: 1px 5px; font-size: 11px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        #action-menu, #emoji-picker { position: absolute; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: none; z-index: 2000; border: 1px solid #eee; padding: 10px; }
        .menu-item { padding: 8px 15px; cursor: pointer; font-size: 14px; border-bottom: 1px solid #f1f5f9; }
        
        /* Input Area */
        .input-area { padding: 10px; border-top: 1px solid #eee; background: white; }
        .emoji-bar { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 8px; font-size: 20px; scrollbar-width: none; }
        .input-row { display: flex; gap: 8px; align-items: center; }
        #msg-input { flex: 1; padding: 12px; border-radius: 20px; border: 1px solid #e2e8f0; font-size: 16px; outline: none; }
        .btn-icon { width: 40px; height: 40px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; background: #f1f5f9; font-size: 18px; }

        #login-screen { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: var(--primary); color: white; text-align: center; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div>
            <h1>Sohbetod</h1>
            <button id="google-login-btn" style="padding:15px 30px; border-radius:15px; border:none; font-weight:bold; cursor:pointer;">Google ile GiriÅŸ Yap</button>
        </div>
    </div>

    <div id="app-container">
        <div id="emoji-picker">
            <span onclick="react('â¤ï¸')">â¤ï¸</span> <span onclick="react('ğŸ˜‚')">ğŸ˜‚</span> <span onclick="react('ğŸ”¥')">ğŸ”¥</span> <span onclick="react('ğŸ‘')">ğŸ‘</span> <span onclick="react('ğŸ˜®')">ğŸ˜®</span>
        </div>

        <div id="action-menu">
            <div class="menu-item" onclick="startEdit()">ğŸ“ DÃ¼zenle</div>
            <div class="menu-item" onclick="deleteMsg()" style="color:red">ğŸ—‘ï¸ Sil</div>
        </div>

        <div class="chat-app">
            <div id="group-info-panel">
                <h2 onclick="toggleInfo()">â† Grup Bilgileri</h2>
                <div id="room-details" style="background:#f8fafc; padding:15px; border-radius:15px; margin-bottom:20px;">
                    <b id="info-room-name">#oda</b>
                    <p style="font-size:12px; color:gray;">Bu oda ÅŸifre ile korunmaktadÄ±r.</p>
                </div>
                <b>Aktif Ãœyeler:</b>
                <div id="user-list" style="margin-top:10px;"></div>
                <button onclick="location.reload()" style="margin-top:auto; padding:15px; border:none; background:#fee2e2; color:red; border-radius:15px; font-weight:600;">Oturumu Kapat</button>
            </div>

            <header>
                <div onclick="toggleInfo()" style="cursor:pointer">
                    <b id="room-display">#oda</b><br>
                    <small id="member-count" style="color:var(--primary);">0 Ã¼ye aktif</small>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn-icon" onclick="shareRoom()">ğŸ”—</button>
                    <button class="btn-icon" onclick="toggleInfo()">â„¹ï¸</button>
                </div>
            </header>

            <div id="messages" onclick="closeMenus()"></div>

            <div class="input-area">
                <div class="emoji-bar">
                    <span onclick="addEmoji('ğŸ˜Š')">ğŸ˜Š</span><span onclick="addEmoji('ğŸ˜‚')">ğŸ˜‚</span><span onclick="addEmoji('ğŸ˜')">ğŸ˜</span><span onclick="addEmoji('ğŸ”¥')">ğŸ”¥</span><span onclick="addEmoji('ğŸ‘')">ğŸ‘</span><span onclick="addEmoji('âœ¨')">âœ¨</span>
                </div>
                <div class="input-row">
                    <input type="file" id="img-input" accept="image/*" style="display:none" onchange="sendImage(this)">
                    <button class="btn-icon" onclick="document.getElementById('img-input').click()">ğŸ–¼ï¸</button>
                    <input type="text" id="msg-input" placeholder="Mesaj yaz..." autocomplete="off">
                    <button id="send-btn" class="btn-icon" onclick="send()" style="background:var(--primary); color:white;">â¤</button>
                </div>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, onValue, set, get, update, remove, onDisconnect, onChildChanged, onChildRemoved } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyCqhaA5yE-V_88mNovVQHOC9k90hsrUYVM",
        authDomain: "sohbet-1e450.firebaseapp.com",
        databaseURL: "https://sohbet-1e450-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "sohbet-1e450",
        storageBucket: "sohbet-1e450.firebasestorage.app",
        appId: "1:339709433578:web:847062b4f5f7e07633e993"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    let myName, myRoom, currentPath, selectedMsgId;

    // --- GÄ°RÄ°Å ---
    document.getElementById("google-login-btn").onclick = () => signInWithPopup(auth, provider);

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            myName = user.displayName;
            document.getElementById("login-screen").style.display = "none";
            document.getElementById("app-container").style.display = "block";
            const urlParams = new URLSearchParams(window.location.search);
            await joinRoom(urlParams.get('room') || "genel");
        }
    });

    async function joinRoom(name) {
        const roomRef = ref(db, `room_configs/${name}`);
        const snap = await get(roomRef);
        let pass = snap.exists() ? prompt("Oda ÅŸifresi:") : prompt("Yeni oda iÃ§in ÅŸifre belirle:");
        
        if (snap.exists() && pass !== snap.val().pass) return joinRoom("genel");
        if (!snap.exists()) await set(roomRef, { pass: pass || "123" });

        myRoom = name;
        currentPath = `rooms/${myRoom}/msgs`;
        document.getElementById("room-display").innerText = "#" + myRoom;
        document.getElementById("info-room-name").innerText = "#" + myRoom;
        
        const presenceRef = ref(db, `rooms/${myRoom}/users/${myName}`);
        set(presenceRef, true);
        onDisconnect(presenceRef).remove();
        loadChat();
    }

    // --- SOHBET VE RESÄ°M ---
    function loadChat() {
        const msgDiv = document.getElementById("messages");
        msgDiv.innerHTML = "";
        
        onChildAdded(ref(db, currentPath), (s) => renderMsg(s.key, s.val()));
        onChildChanged(ref(db, currentPath), (s) => {
            const el = document.getElementById("text-"+s.key);
            if(el) el.innerText = s.val().m;
            updateReactsUI(s.key, s.val().reactions);
        });
        onChildRemoved(ref(db, currentPath), (s) => document.getElementById("wrap-"+s.key)?.remove());
        
        onValue(ref(db, `rooms/${myRoom}/users`), (s) => {
            const users = s.val() || {};
            const count = Object.keys(users).length;
            document.getElementById("member-count").innerText = `${count} Ã¼ye aktif`;
            document.getElementById("user-list").innerHTML = Object.keys(users).map(u => `<div class="menu-item">ğŸ‘¤ ${u}</div>`).join('');
        });
    }

    function renderMsg(id, data) {
        const isMe = data.u === myName;
        const html = `
            <div class="msg-wrapper ${isMe ? 'sent-wrapper' : 'received-wrapper'}" id="wrap-${id}">
                <div class="msg-box ${isMe ? 'sent' : 'received'}" onclick="showMenu(event, '${id}', '${data.u}')">
                    <small style="font-size:10px; display:block; opacity:0.8;">${data.u}</small>
                    ${data.img ? `<img src="${data.img}" class="msg-img">` : `<span id="text-${id}">${data.m}</span>`}
                </div>
                <div class="reactions-row" id="reacts-${id}"></div>
            </div>`;
        document.getElementById("messages").insertAdjacentHTML('beforeend', html);
        updateReactsUI(id, data.reactions);
        document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
    }

    window.send = (img = null) => {
        const inp = document.getElementById("msg-input");
        if (inp.value || img) {
            push(ref(db, currentPath), { u: myName, m: inp.value, img: img, t: Date.now() });
            inp.value = "";
        }
    };

    window.sendImage = (input) => {
        const file = input.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => send(e.target.result);
            reader.readAsDataURL(file);
        }
    };

    // --- MENÃœLER VE EMOJÄ° ---
    window.showMenu = (e, id, user) => {
        e.stopPropagation();
        selectedMsgId = id;
        const picker = document.getElementById("emoji-picker");
        picker.style.display = "flex";
        picker.style.top = (e.clientY - 60) + "px";
        picker.style.left = "20px";

        if (user === myName) {
            const menu = document.getElementById("action-menu");
            menu.style.display = "block";
            menu.style.top = (e.clientY + 20) + "px";
            menu.style.left = "20px";
        }
    };

    window.react = (emoji) => {
        update(ref(db, `${currentPath}/${selectedMsgId}/reactions`), { [myName]: emoji });
        closeMenus();
    };

    function updateReactsUI(id, reacts) {
        const div = document.getElementById("reacts-"+id);
        if(div) div.innerHTML = reacts ? Object.values(reacts).map(r => `<div class="react-badge">${r}</div>`).join('') : '';
    }

    window.startEdit = () => {
        const old = document.getElementById("text-"+selectedMsgId).innerText;
        const n = prompt("DÃ¼zenle:", old);
        if(n) update(ref(db, `${currentPath}/${selectedMsgId}`), { m: n });
        closeMenus();
    };

    window.deleteMsg = () => {
        if(confirm("Silinsin mi?")) remove(ref(db, `${currentPath}/${selectedMsgId}`));
        closeMenus();
    };

    window.closeMenus = () => {
        document.getElementById("emoji-picker").style.display = "none";
        document.getElementById("action-menu").style.display = "none";
    };

    window.addEmoji = (e) => document.getElementById("msg-input").value += e;
    window.toggleInfo = () => document.getElementById("group-info-panel").classList.toggle("active");
    window.shareRoom = () => {
        const url = window.location.origin + window.location.pathname + "?room=" + myRoom;
        navigator.clipboard.writeText(url);
        alert("Oda linki kopyalandÄ±!");
    };
</script>
</body>
</html>
