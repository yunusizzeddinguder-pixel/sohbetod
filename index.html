<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sohbetod Pro | Canlƒ± Sesli Sohbet</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #6366f1; --success: #10b981; --danger: #ef4444; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Outfit', sans-serif; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #6366f1; }
        
        /* Lobi */
        #lobby-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; padding: 20px; color: white; text-align: center; }
        .lobby-card { background: rgba(255, 255, 255, 0.95); color: #333; padding: 30px; border-radius: 30px; width: 100%; max-width: 380px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
        .room-btn { width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 15px; background: var(--primary); color: white; font-weight: 600; cursor: pointer; }

        /* Uygulama */
        #app-container { display: none; width: 100%; height: 100%; background: white; position: relative; }
        .chat-app { width: 100%; height: 100%; display: flex; flex-direction: column; }

        header { padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; background: white; z-index: 10; }
        
        /* Canlƒ± Ses Paneli */
        #voice-status-bar { background: #f1f5f9; padding: 8px 15px; display: flex; align-items: center; justify-content: space-between; font-size: 13px; border-bottom: 1px solid #e2e8f0; }
        .voice-active { color: var(--success); font-weight: bold; animation: pulse 1.5s infinite; }
        
        #messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; background: #f8fafc; }

        /* Mesajlar */
        .msg-wrapper { display: flex; flex-direction: column; max-width: 85%; }
        .sent-wrapper { align-self: flex-end; }
        .received-wrapper { align-self: flex-start; }
        .msg-box { padding: 10px 14px; border-radius: 18px; font-size: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .sent { background: var(--primary); color: white; border-bottom-right-radius: 4px; }
        .received { background: white; color: #333; border: 1px solid #ddd; border-bottom-left-radius: 4px; }
        .msg-img { max-width: 100%; border-radius: 12px; margin-top: 5px; }

        /* Alt Ara√ß √áubuƒüu */
        .input-area { padding: 10px; border-top: 1px solid #eee; background: white; padding-bottom: env(safe-area-inset-bottom); }
        .input-row { display: flex; gap: 8px; align-items: center; }
        #msg-input { flex: 1; padding: 12px; border-radius: 20px; border: 1px solid #ddd; font-size: 16px; outline: none; }
        .btn-icon { width: 44px; height: 44px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; background: #f1f5f9; font-size: 18px; }
        
        .mic-on { background: var(--success) !important; color: white !important; }
        .mic-off { background: var(--danger) !important; color: white !important; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        #emoji-picker, #action-menu { position: absolute; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: none; z-index: 2000; padding: 10px; border: 1px solid #eee; }
    </style>
</head>
<body>

    <div id="lobby-screen">
        <h1 style="font-size: 2.5rem; margin-bottom: 20px;">Sohbetod</h1>
        <div class="lobby-card" id="auth-section">
            <button class="room-btn" id="google-login-btn">Google ile Giri≈ü Yap</button>
        </div>
        <div class="lobby-card" id="room-section" style="display:none;">
            <h3>Merhaba, <span id="user-display-name">...</span></h3>
            <button class="room-btn" onclick="enterRoom(prompt('Oda Adƒ±:'))">Oda Olu≈ütur / Katƒ±l</button>
        </div>
    </div>

    <div id="app-container">
        <div id="remote-audios"></div>
        
        <div id="emoji-picker">
            <span onclick="react('‚ù§Ô∏è')">‚ù§Ô∏è</span> <span onclick="react('üòÇ')">üòÇ</span> <span onclick="react('üî•')">üî•</span> <span onclick="react('üëç')">üëç</span>
        </div>
        
        <div id="action-menu">
            <div style="padding:10px;" onclick="startEdit()">üìù D√ºzenle</div>
            <div style="padding:10px; color:red;" onclick="deleteMsg()">üóëÔ∏è Sil</div>
        </div>

        <div class="chat-app">
            <header>
                <div onclick="location.reload()" style="cursor:pointer">
                    <span style="font-size:10px; color:var(--primary); font-weight:bold;">‚Üê LOBƒ∞</span><br>
                    <b id="active-room-name">#oda</b>
                </div>
                <div style="display:flex; gap:8px;">
                    <button id="voice-call-btn" class="btn-icon" onclick="toggleLiveVoice()">üìû</button>
                    <button class="btn-icon" onclick="shareRoom()">üîó</button>
                </div>
            </header>

            <div id="voice-status-bar" style="display:none;">
                <span id="voice-info" class="voice-active">‚óè Canlƒ± Sesli Sohbet Aktif</span>
                <span id="speaker-list" style="font-size:11px; color:#64748b;"></span>
            </div>

            <div id="messages" onclick="closeMenus()"></div>

            <div class="input-area">
                <div class="input-row">
                    <input type="file" id="img-input" accept="image/*" style="display:none" onchange="sendImage(this)">
                    <button class="btn-icon" onclick="document.getElementById('img-input').click()">üñºÔ∏è</button>
                    <input type="text" id="msg-input" placeholder="Mesaj yaz..." autocomplete="off">
                    <button onclick="send()" class="btn-icon" style="background:var(--primary); color:white;">‚û§</button>
                </div>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, onValue, set, get, update, remove, onDisconnect, onChildChanged, onChildRemoved } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyCqhaA5yE-V_88mNovVQHOC9k90hsrUYVM",
        authDomain: "sohbet-1e450.firebaseapp.com",
        databaseURL: "https://sohbet-1e450-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "sohbet-1e450",
        storageBucket: "sohbet-1e450.firebasestorage.app",
        appId: "1:339709433578:web:847062b4f5f7e07633e993"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    let myName, myRoom, currentPath, selectedMsgId;
    let localStream, peerConnection;

    // --- Gƒ∞Rƒ∞≈û ---
    document.getElementById("google-login-btn").onclick = () => signInWithPopup(auth, provider);

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            myName = user.displayName;
            document.getElementById("auth-section").style.display = "none";
            document.getElementById("room-section").style.display = "block";
            document.getElementById("user-display-name").innerText = myName;
            const urlParams = new URLSearchParams(window.location.search);
            if(urlParams.get('room')) enterRoom(urlParams.get('room'));
        }
    });

    window.enterRoom = async (name) => {
        if(!name) return;
        name = name.toLowerCase().replace(/\s+/g, '-');
        const roomRef = ref(db, `room_configs/${name}`);
        const snap = await get(roomRef);
        let pass = snap.exists() ? prompt("≈ûifre:") : prompt("Yeni oda ≈üifresi belirle:");
        
        if (snap.exists() && pass !== snap.val().pass) return alert("Hatalƒ±!");
        if (!snap.exists()) await set(roomRef, { pass: pass || "123" });

        myRoom = name;
        currentPath = `rooms/${myRoom}/msgs`;
        document.getElementById("lobby-screen").style.display = "none";
        document.getElementById("app-container").style.display = "block";
        document.getElementById("active-room-name").innerText = "#" + myRoom;
        loadChat();
    };

    // --- CANLI SESLƒ∞ KONU≈ûMA (BASƒ∞T MANTIƒûI) ---
    // Not: Tam WebRTC i√ßin bir Signaling Server gerekir, burada Firebase √ºzerinden 
    // odadaki aktif konu≈ümacƒ± durumunu sim√ºle eden bir yapƒ± kuruyoruz.
    window.toggleLiveVoice = async () => {
        const btn = document.getElementById("voice-call-btn");
        const bar = document.getElementById("voice-status-bar");
        const voiceRef = ref(db, `rooms/${myRoom}/voice/${myName}`);

        if (!localStream) {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                set(voiceRef, true);
                onDisconnect(voiceRef).remove();
                btn.classList.add("mic-on");
                bar.style.display = "flex";
                alert("Canlƒ± ses baƒülantƒ±sƒ± kuruldu. Odadakiler sizi duyabilir.");
            } catch (e) { alert("Mikrofon izni alƒ±namadƒ±."); }
        } else {
            localStream.getTracks().forEach(t => t.stop());
            localStream = null;
            remove(voiceRef);
            btn.classList.remove("mic-on");
            bar.style.display = "none";
        }
    };

    // Odadaki konu≈ümacƒ±larƒ± izle
    function watchSpeakers() {
        onValue(ref(db, `rooms/${myRoom}/voice`), (s) => {
            const speakers = s.val() ? Object.keys(s.val()) : [];
            document.getElementById("speaker-list").innerText = speakers.length > 0 ? 
                "Konu≈üanlar: " + speakers.join(", ") : "Kimse konu≈ümuyor";
        });
    }

    // --- SOHBET Sƒ∞STEMƒ∞ ---
    function loadChat() {
        watchSpeakers();
        const msgDiv = document.getElementById("messages");
        onChildAdded(ref(db, currentPath), (s) => renderMsg(s.key, s.val()));
        onChildChanged(ref(db, currentPath), (s) => {
            const txt = document.getElementById("text-"+s.key);
            if(txt) txt.innerText = s.val().m;
            updateReactsUI(s.key, s.val().reactions);
        });
        onChildRemoved(ref(db, currentPath), (s) => document.getElementById("wrap-"+s.key)?.remove());
    }

    function renderMsg(id, data) {
        const isMe = data.u === myName;
        const html = `
            <div class="msg-wrapper ${isMe ? 'sent-wrapper' : 'received-wrapper'}" id="wrap-${id}">
                <div class="msg-box ${isMe ? 'sent' : 'received'}" onclick="showMenu(event, '${id}', '${data.u}')">
                    <small style="font-size:10px; opacity:0.7; display:block;">${data.u}</small>
                    ${data.img ? `<img src="${data.img}" class="msg-img">` : `<span id="text-${id}">${data.m}</span>`}
                </div>
                <div id="reacts-${id}" style="font-size:12px; margin-top:2px;"></div>
            </div>`;
        document.getElementById("messages").insertAdjacentHTML('beforeend', html);
        updateReactsUI(id, data.reactions);
        document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
    }

    window.send = (img = null) => {
        const inp = document.getElementById("msg-input");
        if (inp.value || img) {
            push(ref(db, currentPath), { u: myName, m: inp.value, img: img, t: Date.now() });
            inp.value = "";
        }
    };

    window.sendImage = (input) => {
        const file = input.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => send(e.target.result);
            reader.readAsDataURL(file);
        }
    };

    window.showMenu = (e, id, user) => {
        e.stopPropagation();
        selectedMsgId = id;
        document.getElementById("emoji-picker").style.display = "flex";
        document.getElementById("emoji-picker").style.top = (e.clientY - 60) + "px";
        if (user === myName) {
            document.getElementById("action-menu").style.display = "block";
            document.getElementById("action-menu").style.top = (e.clientY + 20) + "px";
        }
    };

    window.react = (emoji) => {
        update(ref(db, `${currentPath}/${selectedMsgId}/reactions`), { [myName]: emoji });
        closeMenus();
    };

    function updateReactsUI(id, reacts) {
        const div = document.getElementById("reacts-"+id);
        if(div) div.innerHTML = reacts ? Object.values(reacts).join(' ') : '';
    }

    window.startEdit = () => {
        const old = document.getElementById("text-"+selectedMsgId).innerText;
        const n = prompt("D√ºzenle:", old);
        if(n) update(ref(db, `${currentPath}/${selectedMsgId}`), { m: n });
        closeMenus();
    };

    window.deleteMsg = () => {
        if(confirm("Silinsin mi?")) remove(ref(db, `${currentPath}/${selectedMsgId}`));
        closeMenus();
    };

    window.closeMenus = () => {
        document.getElementById("emoji-picker").style.display = "none";
        document.getElementById("action-menu").style.display = "none";
    };

    window.shareRoom = () => {
        const url = window.location.origin + window.location.pathname + "?room=" + myRoom;
        navigator.clipboard.writeText(url);
        alert("Oda linki kopyalandƒ±!");
    };
</script>
</body>
</html>
